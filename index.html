<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .history-item:hover {
            cursor: pointer;
            opacity: 0.8;
            border-color: #3b82f6; /* Blue border on hover */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <p class="text-3xl font-bold">Forging Reality...</p>
    </div>

    <main class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-blue-400">Imagen 3.0 Generator</h1>
            <p class="text-gray-400">Describe your vision and watch the AI bring it to life.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Generation Controls</h2>
                
                <div class="mb-4">
                    <label for="prompt" class="block mb-2 text-sm font-medium">Image Prompt (Be Detailed!)</label>
                    <textarea id="prompt" rows="4" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="A stunning photorealistic astronaut playing guitar on the moon, volumetric lighting, epic." required></textarea>
                </div>

                <div class="mb-6">
                    <label for="aspectRatio" class="block mb-2 text-sm font-medium">Aspect Ratio</label>
                    <select id="aspectRatio" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500">
                        <option value="1:1">Square (1:1)</option>
                        <option value="3:4">Portrait (3:4)</option>
                        <option value="4:3">Landscape (4:3)</option>
                        <option value="16:9">Widescreen (16:9)</option>
                    </select>
                </div>
                
                <button id="generateButton" class="w-full px-5 py-3 text-lg font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                    Generate Image
                </button>

                <p id="error-display" class="text-red-400 mt-4 text-center hidden"></p>
                
                <button id="downloadButton" class="w-full px-5 py-3 mt-4 text-lg font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 hidden" disabled>
                    Download Image
                </button>
            </div>

            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Result</h2>
                <div class="bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center p-4 min-h-[500px]">
                    <img id="mainImage" src="https://via.placeholder.com/600x400.png?text=Generated+Image+Appears+Here" alt="Generated AI Image" class="max-w-full max-h-full object-contain rounded-lg">
                </div>
            </div>
            
        </div>
        
        <div class="mt-10 bg-gray-800 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">History</h2>
            <p id="history-placeholder" class="text-gray-500 text-center p-4">Your generated images will appear here.</p>
            <div id="history-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                </div>
        </div>

    </main>

    <script>
        // Global variables provided by the environment
        const API_KEY = "AIzaSyC1qqRmTxEFMpnYVeuPNxLAp-R7bth8rzs"; 
        
        // âœ… FIX: The IMAGEN_API_URL now correctly uses the API_KEY variable
        const IMAGEN_API_URL = \`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=\${API_KEY}\`;
        
        const promptInput = document.getElementById('prompt');
        const aspectRatioSelect = document.getElementById('aspectRatio');
        const generateButton = document.getElementById('generateButton');
        const mainImage = document.getElementById('mainImage');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorDisplay = document.getElementById('error-display');
        const historyContainer = document.getElementById('history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        
        // Download button variable
        const downloadButton = document.getElementById('downloadButton');

        let imageHistory = [];
        let currentImagePrompt = ""; // New global variable to track the prompt of the currently displayed image

        // Common negative prompt to improve image quality
        const NEGATIVE_PROMPT = "low resolution, blurry, distorted, grainy, text, watermark, extra fingers, malformed hands, ugly, tiling, cropped, signature, logo, duplicate";

        // --- Utility Functions ---

        function toggleLoading(isLoading) {
            loadingOverlay.classList.toggle('hidden', !isLoading);
            generateButton.disabled = isLoading;
            promptInput.disabled = isLoading;
            aspectRatioSelect.disabled = isLoading;
            // Disable download button while loading
            downloadButton.disabled = isLoading; 

            if (isLoading) {
                errorDisplay.classList.add('hidden');
                generateButton.textContent = "Forging Reality...";
            } else {
                generateButton.textContent = "Generate Image";
            }
        }

        function displayError(message) {
            errorDisplay.textContent = \`Error: \${message}\`;
            errorDisplay.classList.remove('hidden');
        }

        function updateHistory() {
            if (historyPlaceholder) historyPlaceholder.classList.add('hidden');
            
            // Clear current history display
            historyContainer.innerHTML = ''; 

            imageHistory.slice().reverse().forEach((item, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = item.url;
                thumbnail.alt = item.prompt.substring(0, 30) + "...";
                thumbnail.className = 'w-full h-auto object-cover rounded-lg shadow-md border-2 border-gray-700 history-item';
                thumbnail.onclick = () => {
                    mainImage.src = item.url; // Set the main image to the clicked history item
                    promptInput.value = item.prompt; // Load the prompt back into the input
                    currentImagePrompt = item.prompt; // Update the current prompt tracker
                    downloadButton.classList.remove('hidden'); // Ensure download is visible
                    downloadButton.disabled = false;
                };
                historyContainer.appendChild(thumbnail);
            });
        }
        
        // Function to handle image download
        function downloadImage() {
            const url = mainImage.src;
            // Use the 'currentImagePrompt' for the filename instead of relying on the input field
            const filenamePrompt = currentImagePrompt || promptInput.value.trim(); 

            if (url.startsWith('data:image/png;base64,')) {
                // 1. Create a temporary anchor element
                const a = document.createElement('a');
                a.href = url;
                
                // 2. Generate a filename from the prompt and timestamp
                let filename = filenamePrompt.substring(0, 30).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                if (filename.length === 0) {
                    filename = 'ai_image';
                }
                a.download = \`\${filename}_\${Date.now()}.png\`;

                // 3. Programmatically click the link to trigger the download
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                displayError("No generated image data available for download.");
            }
        }

        // --- Imagen API Call Logic ---

        async function generateImage(retryCount = 0) {
            const userPrompt = promptInput.value.trim();
            const selectedAspect = aspectRatioSelect.value;
            let lastError = null; // Variable to store the last error message

            if (!userPrompt) {
                displayError("Please enter a detailed prompt to generate an image.");
                return;
            }

            toggleLoading(true);

            const payload = {
                instances: [{
                    prompt: userPrompt,
                    aspectRatio: selectedAspect,
                    negativePrompt: NEGATIVE_PROMPT
                }],
                parameters: {
                    sampleCount: 1, // Only generate 1 image
                }
            };

            try {
                const response = await fetch(IMAGEN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    const errorMessage = errorBody.error?.message || \`HTTP error! status: \${response.status}\`;
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = \`data:image/png;base64,\${base64Data}\`;

                    mainImage.src = imageUrl; // Update main image
                    
                    // Set the current image prompt for accurate downloads
                    currentImagePrompt = userPrompt; 

                    // Show and enable download button on success
                    downloadButton.classList.remove('hidden'); 
                    downloadButton.disabled = false;

                    // Add to history
                    imageHistory.push({
                        url: imageUrl,
                        prompt: userPrompt,
                        aspectRatio: selectedAspect
                    });

                    updateHistory();
                    return; // Exit successfully
                } else {
                    throw new Error("API did not return a valid image.");
                }
            } catch (error) {
                console.error("Imagen API Error:", error);
                lastError = error.message; // Store the current error
                
                // Implement exponential backoff for throttling/transient errors
                if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    await generateImage(retryCount + 1); // Retry the call
                } else {
                    // Display the actual error message from the last attempt
                    displayError(\`Failed to generate image after retries. (\${lastError || 'Check console for details'})\`); 
                }
            } finally {
                // Only stop loading if the final attempt (retryCount === 3 or initial success) is complete
                if (retryCount >= 3 || lastError === null) {
                    toggleLoading(false);
                }
            }
        }

        // --- Initialization and Event Listeners ---

        // Set initial focus and initialize current prompt
        window.onload = () => {
            promptInput.focus();
            currentImagePrompt = promptInput.value.trim(); // Initialize current prompt
            
            // Attach functions to the button click events
            generateButton.addEventListener('click', generateImage);
            downloadButton.addEventListener('click', downloadImage);
        };
    </script>
</body>
</html>
