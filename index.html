<script>
    // Global variables provided by the environment
    const API_KEY = "AIzaSyC1qqRmTxEFMpnYVeuPNxLAp-R7bth8rzs"; // Canvas will automatically provide the key. (Do not change this line)
    
    // ðŸ’¡ FIX: This now correctly uses the JavaScript variable ${API_KEY}
    const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
    
    const promptInput = document.getElementById('prompt');
    const aspectRatioSelect = document.getElementById('aspectRatio');
    const generateButton = document.getElementById('generateButton');
    const mainImage = document.getElementById('mainImage');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorDisplay = document.getElementById('error-display');
    const historyContainer = document.getElementById('history-container');
    const historyPlaceholder = document.getElementById('history-placeholder');
    
    // Download button variable
    const downloadButton = document.getElementById('downloadButton');

    let imageHistory = [];
    let currentImagePrompt = ""; // New global variable to track the prompt of the currently displayed image

    // Common negative prompt to improve image quality
    const NEGATIVE_PROMPT = "low resolution, blurry, distorted, grainy, text, watermark, extra fingers, malformed hands, ugly, tiling, cropped, signature, logo, duplicate";

    // --- Utility Functions ---

    function toggleLoading(isLoading) {
        loadingOverlay.classList.toggle('hidden', !isLoading);
        generateButton.disabled = isLoading;
        promptInput.disabled = isLoading;
        aspectRatioSelect.disabled = isLoading;
        // Disable download button while loading
        downloadButton.disabled = isLoading; 

        if (isLoading) {
            errorDisplay.classList.add('hidden');
            generateButton.textContent = "Forging Reality...";
        } else {
            generateButton.textContent = "Generate Image";
        }
    }

    function displayError(message) {
        errorDisplay.textContent = `Error: ${message}`;
        errorDisplay.classList.remove('hidden');
    }

    function updateHistory() {
        if (historyPlaceholder) historyPlaceholder.classList.add('hidden');
        
        // Clear current history display
        historyContainer.innerHTML = ''; 

        imageHistory.slice().reverse().forEach((item, index) => {
            const thumbnail = document.createElement('img');
            thumbnail.src = item.url;
            thumbnail.alt = item.prompt.substring(0, 30) + "...";
            thumbnail.className = 'w-full h-auto object-cover rounded-lg shadow-md border-2 border-gray-700 history-item';
            thumbnail.onclick = () => {
                mainImage.src = item.url; // Set the main image to the clicked history item
                promptInput.value = item.prompt; // Load the prompt back into the input
                currentImagePrompt = item.prompt; // Update the current prompt tracker
                downloadButton.classList.remove('hidden'); // Ensure download is visible
                downloadButton.disabled = false;
            };
            historyContainer.appendChild(thumbnail);
        });
    }
    
    // Function to handle image download
    function downloadImage() {
        const url = mainImage.src;
        // Use the 'currentImagePrompt' for the filename instead of relying on the input field
        const filenamePrompt = currentImagePrompt || promptInput.value.trim(); 

        if (url.startsWith('data:image/png;base64,')) {
            // 1. Create a temporary anchor element
            const a = document.createElement('a');
            a.href = url;
            
            // 2. Generate a filename from the prompt and timestamp
            let filename = filenamePrompt.substring(0, 30).replace(/[^a-z0-9]/gi, '_').toLowerCase();
            if (filename.length === 0) {
                filename = 'ai_image';
            }
            a.download = `${filename}_${Date.now()}.png`;

            // 3. Programmatically click the link to trigger the download
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } else {
            displayError("No generated image data available for download.");
        }
    }

    // --- Imagen API Call Logic ---

    async function generateImage(retryCount = 0) {
        const userPrompt = promptInput.value.trim();
        const selectedAspect = aspectRatioSelect.value;
        let lastError = null; // Variable to store the last error message

        if (!userPrompt) {
            displayError("Please enter a detailed prompt to generate an image.");
            return;
        }

        toggleLoading(true);

        const payload = {
            instances: [{
                prompt: userPrompt,
                aspectRatio: selectedAspect,
                negativePrompt: NEGATIVE_PROMPT
            }],
            parameters: {
                sampleCount: 1, // Only generate 1 image
            }
        };

        try {
            const response = await fetch(IMAGEN_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const errorMessage = errorBody.error?.message || `HTTP error! status: ${response.status}`;
                throw new Error(errorMessage);
            }

            const result = await response.json();

            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const base64Data = result.predictions[0].bytesBase64Encoded;
                const imageUrl = `data:image/png;base64,${base64Data}`;

                mainImage.src = imageUrl; // Update main image
                
                // Set the current image prompt for accurate downloads
                currentImagePrompt = userPrompt; 

                // Show and enable download button on success
                downloadButton.classList.remove('hidden'); 
                downloadButton.disabled = false;

                // Add to history
                imageHistory.push({
                    url: imageUrl,
                    prompt: userPrompt,
                    aspectRatio: selectedAspect
                });

                updateHistory();
                return; // Exit successfully
            } else {
                throw new Error("API did not return a valid image.");
            }
        } catch (error) {
            console.error("Imagen API Error:", error);
            lastError = error.message; // Store the current error
            
            // Implement exponential backoff for throttling/transient errors
            if (retryCount < 3) {
                const delay = Math.pow(2, retryCount) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                await generateImage(retryCount + 1); // Retry the call
            } else {
                // Display the actual error message from the last attempt
                displayError(`Failed to generate image after retries. (${lastError || 'Check console for details'})`); 
            }
        } finally {
            // Only stop loading if the final attempt (retryCount === 3 or initial success) is complete
            if (retryCount >= 3 || lastError === null) {
                toggleLoading(false);
            }
        }
    }

    // --- Initialization and Event Listeners ---

    // Set initial focus and initialize current prompt
    window.onload = () => {
        promptInput.focus();
        currentImagePrompt = promptInput.value.trim(); // Initialize current prompt
        
        // ðŸš€ Add Event Listeners for the buttons
        generateButton.addEventListener('click', generateImage);
        downloadButton.addEventListener('click', downloadImage);
    };

</script>
