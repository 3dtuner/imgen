<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator Recoded</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .history-item:hover {
            cursor: pointer;
            opacity: 0.8;
            border-color: #3b82f6; /* Blue border on hover */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <p class="text-3xl font-bold">Forging Reality...</p>
    </div>

    <main class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-blue-400">Imagen 3.0 Generator (Recoded)</h1>
            <p class="text-gray-400">Describe your vision and watch the AI bring it to life.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Generation Controls</h2>
                
                <div class="mb-4">
                    <label for="prompt" class="block mb-2 text-sm font-medium">Image Prompt (Be Detailed!)</label>
                    <textarea id="prompt" rows="4" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500" placeholder="A stunning photorealistic astronaut playing guitar on the moon, volumetric lighting, epic." required></textarea>
                </div>

                <div class="mb-6">
                    <label for="aspectRatio" class="block mb-2 text-sm font-medium">Aspect Ratio</label>
                    <select id="aspectRatio" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500">
                        <option value="1:1">Square (1:1)</option>
                        <option value="3:4">Portrait (3:4)</option>
                        <option value="4:3">Landscape (4:3)</option>
                        <option value="16:9">Widescreen (16:9)</option>
                    </select>
                </div>
                
                <button id="generateButton" class="w-full px-5 py-3 text-lg font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                    Generate Image
                </button>

                <p id="error-display" class="text-red-400 mt-4 text-center hidden"></p>
                
                <button id="downloadButton" class="w-full px-5 py-3 mt-4 text-lg font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 hidden" disabled>
                    Download Image
                </button>
            </div>

            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Result</h2>
                <div class="bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center p-4 min-h-[500px]">
                    <img id="mainImage" src="https://via.placeholder.com/600x400.png?text=Generated+Image+Appears+Here" alt="Generated AI Image" class="max-w-full max-h-full object-contain rounded-lg">
                </div>
            </div>
            
        </div>
        
        <div class="mt-10 bg-gray-800 p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">History</h2>
            <p id="history-placeholder" class="text-gray-500 text-center p-4">Your generated images will appear here.</p>
            <div id="history-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                </div>
        </div>

    </main>

    <script>
        // 1. ENVIRONMENT & CONSTANTS
        const API_KEY = "AIzaSyC1qqRmTxEFMpnYVeuPNxLAp-R7bth8rzs"; 
        // Using concatenation to avoid template literal syntax issues
        const IMAGEN_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=' + API_KEY;
        const NEGATIVE_PROMPT = "low resolution, blurry, distorted, grainy, text, watermark, extra fingers, malformed hands, ugly, tiling, cropped, signature, logo, duplicate";
        
        // 2. DOM ELEMENT REFERENCES
        const DOM = {
            promptInput: document.getElementById('prompt'),
            aspectRatioSelect: document.getElementById('aspectRatio'),
            generateButton: document.getElementById('generateButton'),
            mainImage: document.getElementById('mainImage'),
            loadingOverlay: document.getElementById('loading-overlay'),
            errorDisplay: document.getElementById('error-display'),
            historyContainer: document.getElementById('history-container'),
            historyPlaceholder: document.getElementById('history-placeholder'),
            downloadButton: document.getElementById('downloadButton')
        };

        // 3. GLOBAL STATE
        let imageHistory = [];
        let currentImagePrompt = ""; 
        
        // --- UTILITY FUNCTIONS ---

        function toggleLoading(isLoading) {
            DOM.loadingOverlay.classList.toggle('hidden', !isLoading);
            DOM.generateButton.disabled = isLoading;
            DOM.promptInput.disabled = isLoading;
            DOM.aspectRatioSelect.disabled = isLoading;
            DOM.downloadButton.disabled = isLoading; 

            if (isLoading) {
                DOM.errorDisplay.classList.add('hidden');
                DOM.generateButton.textContent = "Forging Reality...";
            } else {
                DOM.generateButton.textContent = "Generate Image";
            }
        }

        function displayError(message) {
            DOM.errorDisplay.textContent = 'Error: ' + message;
            DOM.errorDisplay.classList.remove('hidden');
        }

        function updateHistory() {
            if (DOM.historyPlaceholder) DOM.historyPlaceholder.classList.add('hidden');
            
            DOM.historyContainer.innerHTML = ''; 

            imageHistory.slice().reverse().forEach(item => {
                const thumbnail = document.createElement('img');
                thumbnail.src = item.url;
                thumbnail.alt = item.prompt.substring(0, 30) + "...";
                thumbnail.className = 'w-full h-auto object-cover rounded-lg shadow-md border-2 border-gray-700 history-item';
                
                // Click handler to load image back into main view
                thumbnail.onclick = () => {
                    DOM.mainImage.src = item.url; 
                    DOM.promptInput.value = item.prompt; 
                    currentImagePrompt = item.prompt; 
                    DOM.downloadButton.classList.remove('hidden'); 
                    DOM.downloadButton.disabled = false;
                };
                DOM.historyContainer.appendChild(thumbnail);
            });
        }

        function downloadImage() {
            const url = DOM.mainImage.src;
            const filenamePrompt = currentImagePrompt || DOM.promptInput.value.trim(); 

            if (url.startsWith('data:image/png;base64,')) {
                const a = document.createElement('a');
                a.href = url;
                
                let filename = filenamePrompt.substring(0, 30).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                if (filename.length === 0) {
                    filename = 'ai_image';
                }
                // Using concatenation
                a.download = filename + '_' + Date.now() + '.png';

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                displayError("No generated image data available for download.");
            }
        }

        // --- CORE LOGIC: IMAGE GENERATION ---

        async function handleImageGeneration(retryCount = 0) {
            const userPrompt = DOM.promptInput.value.trim();
            const selectedAspect = DOM.aspectRatioSelect.value;
            let lastError = null; 

            if (!userPrompt) {
                displayError("Please enter a detailed prompt to generate an image.");
                return;
            }

            toggleLoading(true);

            const payload = {
                instances: [{
                    prompt: userPrompt,
                    aspectRatio: selectedAspect,
                    negativePrompt: NEGATIVE_PROMPT
                }],
                parameters: { sampleCount: 1 }
            };

            try {
                const response = await fetch(IMAGEN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    const errorMessage = errorBody.error?.message || 'HTTP error! status: ' + response.status;
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    // FIX: Reliable string concatenation for the critical line
                    const imageUrl = 'data:image/png;base64,' + base64Data; 

                    DOM.mainImage.src = imageUrl;
                    currentImagePrompt = userPrompt; 
                    DOM.downloadButton.classList.remove('hidden'); 
                    DOM.downloadButton.disabled = false;

                    imageHistory.push({ url: imageUrl, prompt: userPrompt, aspectRatio: selectedAspect });
                    updateHistory();
                    return; 
                } else {
                    throw new Error("API did not return a valid image.");
                }
            } catch (error) {
                console.error("Imagen API Error:", error);
                lastError = error.message; 
                
                if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    await handleImageGeneration(retryCount + 1); 
                } else {
                    displayError('Failed to generate image after retries. (' + (lastError || 'Check console for details') + ')'); 
                }
            } finally {
                if (retryCount >= 3 || lastError === null) {
                    toggleLoading(false);
                }
            }
        }

        // --- INITIALIZATION ---

        function setupEventListeners() {
            DOM.generateButton.addEventListener('click', handleImageGeneration);
            DOM.downloadButton.addEventListener('click', downloadImage);
            DOM.promptInput.focus();
            currentImagePrompt = DOM.promptInput.value.trim(); 
        }

        // Wait until the HTML elements are fully loaded before running the script
        document.addEventListener('DOMContentLoaded', setupEventListeners);
    </script>
</body>
</html>
